<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal AI Chat</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gemini: { bg: '#131314', surface: '#1e1f20', hover: '#333537', border: '#444746' }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #131314; color: #e3e3e3; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444746; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #5f6368; }

        /* Markdown Styles */
        .markdown-body p { margin-bottom: 1rem; }
        .markdown-body pre { background: #131314; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-bottom: 1rem; border: 1px solid #444746; font-family: monospace; }
        .markdown-body code { background: #131314; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-family: monospace; font-size: 0.875em; }
        .markdown-body ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
        .markdown-body ol { list-style-type: decimal; margin-left: 1.5rem; margin-bottom: 1rem; }
        .markdown-body strong { color: #fff; font-weight: 600; }
    </style>
</head>
<body class="h-screen flex overflow-hidden selection:bg-blue-500/30">

    <aside class="w-72 bg-gemini-surface flex-shrink-0 flex flex-col border-r border-gemini-border transition-all duration-300 z-20 hidden md:flex" id="sidebar">
        <div class="p-4">
            <button onclick="app.createNewChat()" class="w-full flex items-center gap-2 px-4 py-3 bg-[#282a2c] hover:bg-gemini-hover rounded-full text-sm font-medium transition-colors border border-gemini-border">
                <i data-lucide="plus" class="w-4 h-4"></i> New Chat
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto px-3 space-y-1" id="chatHistory">
            </div>

        <div class="p-4 border-t border-gemini-border mt-auto">
            <button onclick="app.toggleSettings(true)" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-gemini-hover rounded-xl text-sm transition-colors text-gray-300">
                <i data-lucide="settings" class="w-5 h-5"></i> Settings
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative min-w-0">
        <header class="h-16 flex items-center justify-between px-4 sticky top-0 bg-gemini-bg/90 backdrop-blur-sm z-10">
            <div class="flex items-center gap-3">
                <button onclick="document.getElementById('sidebar').classList.toggle('hidden')" class="md:hidden p-2 hover:bg-gemini-surface rounded-full">
                    <i data-lucide="menu" class="w-5 h-5"></i>
                </button>
                <span class="text-xl font-medium bg-gradient-to-r from-blue-400 via-indigo-400 to-purple-400 bg-clip-text text-transparent">Universal AI</span>
            </div>
        </header>

        <div id="chatContainer" class="flex-1 overflow-y-auto px-4 md:px-20 lg:px-48 pb-6 pt-4 scroll-smooth">
            <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center text-center space-y-4">
                <div class="w-16 h-16 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center mb-4 opacity-80">
                    <i data-lucide="sparkles" class="w-8 h-8 text-white"></i>
                </div>
                <h1 class="text-3xl font-medium text-gray-200">How can I help you today?</h1>
                <p class="text-gray-500 max-w-md">Enter your OpenRouter API key in the settings to start generating responses.</p>
            </div>
            
            <div id="messagesWrapper" class="space-y-6 hidden pb-20">
                </div>
        </div>

        <div class="p-4 md:px-20 lg:px-48 bg-gradient-to-t from-gemini-bg via-gemini-bg to-transparent absolute bottom-0 w-full">
            <div class="relative flex items-end gap-2 bg-gemini-surface rounded-3xl border border-gemini-border p-2 focus-within:border-gray-400 transition-colors shadow-lg">
                <textarea id="userInput" rows="1" placeholder="Ask anything..." 
                    class="w-full max-h-48 bg-transparent border-none focus:ring-0 resize-none py-3 px-4 text-gray-100 placeholder-gray-500 outline-none leading-relaxed"
                    oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
                <div class="flex justify-end p-2 flex-shrink-0">
                    <button id="sendBtn" onclick="app.sendMessage()" class="p-3 bg-gray-200 text-black rounded-full hover:bg-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="arrow-up" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <p class="text-center text-xs text-gray-500 mt-3 pb-2">Responses are generated by AI and may be inaccurate.</p>
        </div>
    </main>

    <div id="settingsModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity">
        <div class="bg-gemini-surface w-full max-w-md rounded-2xl border border-gemini-border p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-medium">Configuration</h2>
                <button onclick="app.toggleSettings(false)" class="text-gray-400 hover:text-white p-1 rounded-full hover:bg-gemini-hover transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">OpenRouter API Key</label>
                    <input type="password" id="apiKey" placeholder="sk-or-v1-..." class="w-full bg-gemini-bg border border-gemini-border rounded-xl p-3 focus:border-blue-500 outline-none text-white transition-colors">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Model ID</label>
                    <input type="text" id="modelName" placeholder="google/gemini-pro" class="w-full bg-gemini-bg border border-gemini-border rounded-xl p-3 focus:border-blue-500 outline-none text-white transition-colors">
                    <p class="text-xs text-gray-500 mt-2">Example: google/gemini-2.0-pro-exp-02-05:free</p>
                </div>
                <div class="pt-4 border-t border-gemini-border">
                    <button onclick="app.saveSettings()" class="w-full bg-gray-200 hover:bg-white text-black font-medium py-3 rounded-xl transition-colors">Save & Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const app = {
            chats: [],
            currentChatId: null,
            config: { key: '', model: 'google/gemini-2.0-flash-lite-preview-02-05:free' },

            init() {
                lucide.createIcons();
                
                // Load Data
                this.chats = JSON.parse(localStorage.getItem('universal_ai_chats') || '[]');
                this.config = JSON.parse(localStorage.getItem('universal_ai_config')) || this.config;
                
                // Populate Settings
                document.getElementById('apiKey').value = this.config.key;
                document.getElementById('modelName').value = this.config.model;

                // Event Listeners
                document.getElementById('userInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.renderHistory();
                if (this.chats.length > 0) {
                    this.selectChat(this.chats[0].id);
                }
            },

            toggleSettings(show) {
                document.getElementById('settingsModal').classList.toggle('hidden', !show);
            },

            saveSettings() {
                this.config.key = document.getElementById('apiKey').value.trim();
                this.config.model = document.getElementById('modelName').value.trim() || 'google/gemini-2.0-flash-lite-preview-02-05:free';
                localStorage.setItem('universal_ai_config', JSON.stringify(this.config));
                this.toggleSettings(false);
            },

            createNewChat() {
                const id = Date.now().toString();
                this.currentChatId = id;
                this.chats.unshift({ id, title: 'New Conversation', messages: [] });
                this.saveData();
                this.renderHistory();
                this.renderChat();
            },

            selectChat(id) {
                this.currentChatId = id;
                this.renderHistory();
                this.renderChat();
            },

            renderHistory() {
                const container = document.getElementById('chatHistory');
                container.innerHTML = this.chats.map(chat => `
                    <button onclick="app.selectChat('${chat.id}')" class="w-full text-left px-4 py-2.5 rounded-xl text-sm truncate transition-colors ${this.currentChatId === chat.id ? 'bg-[#282a2c] text-blue-400 font-medium' : 'text-gray-300 hover:bg-gemini-hover'}">
                        ${chat.title}
                    </button>
                `).join('');
            },

            renderChat() {
                const wrapper = document.getElementById('messagesWrapper');
                const welcome = document.getElementById('welcomeScreen');
                const activeChat = this.chats.find(c => c.id === this.currentChatId);

                if (!activeChat || activeChat.messages.length === 0) {
                    wrapper.classList.add('hidden');
                    welcome.classList.remove('hidden');
                    return;
                }

                welcome.classList.add('hidden');
                wrapper.classList.remove('hidden');
                
                wrapper.innerHTML = activeChat.messages.map(msg => `
                    <div class="flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'}">
                        ${msg.role === 'assistant' ? 
                            `<div class="flex items-center gap-3 mb-2">
                                <div class="w-6 h-6 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center">
                                    <i data-lucide="sparkles" class="w-3 h-3 text-white"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-400">AI Model</span>
                            </div>` : ''
                        }
                        <div class="max-w-[100%] md:max-w-[85%] ${msg.role === 'user' ? 'bg-[#282a2c] px-5 py-3.5 rounded-3xl rounded-br-sm text-gray-100' : 'text-gray-200 markdown-body'}">
                            ${msg.role === 'user' ? this.escapeHTML(msg.content) : marked.parse(msg.content)}
                        </div>
                    </div>
                `).join('');
                
                lucide.createIcons();
                this.scrollToBottom();
            },

            async sendMessage() {
                const input = document.getElementById('userInput');
                const btn = document.getElementById('sendBtn');
                const text = input.value.trim();
                
                if (!text) return;
                if (!this.config.key) {
                    this.toggleSettings(true);
                    return;
                }

                if (!this.currentChatId) this.createNewChat();
                
                const activeChat = this.chats.find(c => c.id === this.currentChatId);
                
                // Set Title on first message
                if (activeChat.messages.length === 0) {
                    activeChat.title = text.substring(0, 30) + (text.length > 30 ? '...' : '');
                }

                // Add User Message
                activeChat.messages.push({ role: 'user', content: text });
                
                // Reset Input UI
                input.value = '';
                input.style.height = 'auto';
                btn.disabled = true;
                
                // Add temporary loading message
                activeChat.messages.push({ role: 'assistant', content: 'Thinking...', isTemp: true });
                this.renderChat();
                this.renderHistory();

                try {
                    // Filter out temp messages for the API request
                    const apiMessages = activeChat.messages
                        .filter(m => !m.isTemp)
                        .map(m => ({ role: m.role, content: m.content }));

                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${this.config.key}`,
                            "Content-Type": "application/json",
                            "HTTP-Referer": window.location.href, // Recommended by OpenRouter
                            "X-Title": "Universal AI Interface" // Recommended by OpenRouter
                        },
                        body: JSON.stringify({
                            model: this.config.model,
                            messages: apiMessages
                        })
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    
                    // Remove temp message and add real response
                    activeChat.messages.pop(); 
                    activeChat.messages.push({ 
                        role: 'assistant', 
                        content: data.choices[0]?.message?.content || "No response generated." 
                    });

                } catch (error) {
                    console.error("API Error:", error);
                    activeChat.messages.pop();
                    activeChat.messages.push({ 
                        role: 'assistant', 
                        content: `**Error connecting to API:** \`${error.message}\`. Please check your API key and network connection.` 
                    });
                } finally {
                    btn.disabled = false;
                    this.saveData();
                    this.renderChat();
                    // Focus input back for continuous typing
                    input.focus(); 
                }
            },

            saveData() {
                localStorage.setItem('universal_ai_chats', JSON.stringify(this.chats));
            },

            scrollToBottom() {
                const container = document.getElementById('chatContainer');
                container.scrollTop = container.scrollHeight;
            },

            escapeHTML(str) {
                return str.replace(/[&<>'"]/g, 
                    tag => ({
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        "'": '&#39;',
                        '"': '&quot;'
                    }[tag])
                );
            }
        };

        // Boot the app
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
